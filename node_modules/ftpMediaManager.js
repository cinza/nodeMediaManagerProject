var Client = require('ftp');
var client = client || new Client();
var FTPConfig = {host: global.FTPHost,
              
              user: global.FTPUser,
              password: global.FTPPassword              
            };

client.on('greeting', function(msg) {
  console.log(msg);  
});

client.on('ready', function() {
  console.log('FTP authentication successful.');
});

client.on('close', function(err) {
  console.log('FTP connection closed.');  
});

client.on('end', function() {
  console.log('FTP connection ended.');  
});

client.on('error', function(err) {
  console.log('FTP connection error.');
  console.log(JSON.stringify(err));  
});

var connect = function(next){
  console.log('FTP connecting');
  console.log(FTPConfig);
  client = new Client();
  client.connect(FTPConfig);  
};

var end = function(){
  console.log('FTP disonnecting');
  client.end();
};

var createDirectory = function(name, next){
  console.log('Creating directory named '+ name);
  client.mkdir(global.FTPFolder +'/'+ name, false, function(err) {
    if (err) {
      console.log('FTP error creating directory '+ name);
      next(err);
    }else{
      console.log('FTP Directory created with name '+ name);      
      next(null, name)
    };    
  });
};

var getFiles = function(code, next){
  console.log('Listing files from '+ code);
  // console.log(client);
  client.list(global.FTPFolder +'/'+ code, function(err, list) {
    if (err){
      console.log('FTP error listing directory '+ code);
      next(err);
    }else{            
      next(err, list);
    };    
  });
};

var getFile = function(code, name, next){
  console.log('Getting file '+ name +' from '+ code);
  client.get(global.FTPFolder +'/'+ code +'/'+ name, function(err, fileStream) {
    if (err){
      console.log('FTP error getting file '+ name +' from directory '+ code);      
      next(err);
    }else{
      next(err, fileStream);
    };    
  });
};

connect();

exports.createDirectory = createDirectory;
exports.getFiles = getFiles;
exports.getFile = getFile;
